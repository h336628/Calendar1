<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æš–ç”·æ—¥æ›†</title>
    
    <!-- iOS PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æš–ç”·æ—¥æ›†">
    
    <!-- è¨­å®šä¸»ç•«é¢åœ–ç¤ºç‚º icon.jpg -->
    <link rel="apple-touch-icon" href="icon.jpg">
    <link rel="shortcut icon" href="icon.jpg">
    
    <!-- Tailwind CSS with Dark Mode Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1b26',
                            card: '#24283b',
                            text: '#a9b1d6',
                            accent: '#f7768e'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts: åœ“é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* æ—¥ç³»å‹•æ¼«é¢¨æ ¼å…¨åŸŸè¨­å®š */
        body {
            font-family: 'M PLUS Rounded 1c', 'Kosugi Maru', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: #fff0f5; /* Lavender Blush */
            background-image: radial-gradient(#ffd1dc 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            transition: background-color 0.3s ease;
        }

        /* æ·±è‰²æ¨¡å¼èƒŒæ™¯ */
        .dark body {
            background-color: #1a1b26;
            background-image: radial-gradient(#2f334d 1.5px, transparent 1.5px);
        }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å‹•ç•« */
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .animate-wiggle { animation: wiggle 0.5s ease-in-out; }
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="h-[100dvh] w-full flex justify-center overflow-hidden dark:bg-gray-900">

    <div id="root" class="w-full h-full max-w-md bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm relative shadow-2xl overflow-hidden border-x border-pink-100 dark:border-gray-800 transition-colors duration-300"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        // --- å…§å»ºåœ–ç¤ºåº« (SVG Paths) ---
        const ICONS = {
            Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></g>,
            Settings: <g><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></g>,
            BarChart2: <g><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></g>,
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>,
            X: <g><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></g>,
            Droplet: <path d="M12 2.69l5.74 5.74c1.54 1.54 2.41 3.6 2.41 5.79 0 4.53-3.67 8.2-8.2 8.2S3.8 18.75 3.8 14.22c0-2.18.87-4.25 2.41-5.79L12 2.69z"></path>,
            Thermometer: <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path>,
            Smile: <g><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></g>,
            Heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>,
            Bell: <g><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></g>,
            Lock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></g>,
            ChevronLeft: <polyline points="15 18 9 12 15 6"></polyline>,
            ChevronRight: <polyline points="9 18 15 12 9 6"></polyline>,
            Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>,
            Coffee: <g><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></g>,
            Moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>,
            Sun: <g><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></g>
        };

        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const content = ICONS[name];
            if (!content) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {content}
                </svg>
            );
        };

        // --- Qç‰ˆåœ–ç‰‡ (æ—¥æ›†ç”¨) ---
        const Q_IMAGES = {
            smile: "Q_Default_Smile.png",
            worry: "Q_Worry.png",
            love: "Q_Love_Happy.png",
            encourage: "Q_Encourage.png"
        };

        // --- æ­£å¸¸æ¯”ä¾‹åœ–ç‰‡ (ç›¸è™•ç”¨) ---
        const NORMAL_IMAGES = {
            normal: "normal.png",
            cocoa: "normal_cocoa.png",
            shy: "normal_shy.png",
            worry: "normal_worry.png",
            lovey_happy: "normal_Lovey_happy.png" // æ–°å¢ï¼šå°æ‡‰é–‹å¿ƒ/æ„›å¿ƒå°è©±
        };

        // --- å°è©±è³‡æ–™åº« ---
        const MASCOT_DIALOGUES = {
            pre_period: [
                "{{name}}ï¼Œå¿«åˆ°é‚£å€‹æ™‚å€™å›‰ï¼Œ\nç”Ÿç†ç”¨å“æº–å‚™å¥½äº†å—ï¼Ÿ",
                "{{name}} æœ€è¿‘åˆ¥åƒå¤ªå†°å–”ï¼Œ\næˆ‘æœƒæ“”å¿ƒçš„ã€‚",
                "è…°æœƒç— å—ï¼Ÿ\n{{name}} ä»Šæ™šæ—©é»ä¼‘æ¯å§ã€‚",
                "é€™å¹¾å¤©æƒ…ç·’èµ·ä¼å¤§\næ˜¯æ­£å¸¸çš„ï¼Œæˆ‘åœ¨é€™ã€‚"
            ],
            period: [
                "{{name}} è¦å¤šä¼‘æ¯å–”ï¼Œ\nåˆ¥å¤ªå‹‰å¼·è‡ªå·±ã€‚",
                "å¾ˆç—›çš„è©±åƒæ­¢ç—›è—¥\nä¹Ÿæ²’é—œä¿‚çš„ã€‚",
                "è¾›è‹¦äº†...\nå–é»ç†±æ°´æš–æš–èº«å­ã€‚",
                "æŠ±æŠ±ï¼\n{{name}} è¦å¥½å¥½ç…§é¡§è‡ªå·±å–”ï¼"
            ],
            ovulation: [
                "é€™å¹¾å¤©æ˜¯æ’åµæœŸï¼Œ\n{{name}} çš„æ°£è‰²çœ‹èµ·ä¾†å¾ˆæ£’ï¼",
                "æ„Ÿè¦ºå¦³ä»Šå¤©\nç‰¹åˆ¥æœ‰é­…åŠ›å‘¢âœ¨",
                "ä¸ç®¡ {{name}} åšä»€éº¼ï¼Œ\næˆ‘éƒ½æ”¯æŒå¦³ï¼"
            ],
            follicular: [
                "åˆæ˜¯æ´»åŠ›æ»¿æ»¿çš„ä¸€é€±ï¼\n{{name}} åŠ æ²¹ï¼",
                "ä»Šå¤©å¿ƒæƒ…å¦‚ä½•å‘¢ï¼Ÿ\n{{name}} çœ‹èµ·ä¾†å¾ˆä¸éŒ¯ï¼",
                "åˆ¥å¿˜äº†å¤šå–æ°´ï¼Œ\nä¿æŒæ°´å«©å«©ğŸ’§"
            ],
            late: [
                "é‚£å€‹é‚„æ²’ä¾†å—ï¼Ÿ\n{{name}} æœ€è¿‘å£“åŠ›æ˜¯ä¸æ˜¯å¤ªå¤§äº†ï¼Ÿ",
                "å¦‚æœè¦ºå¾—ç´¯ï¼Œ\nå°±åœä¸‹ä¾†ä¼‘æ¯ä¸€ä¸‹å§ã€‚",
                "ä¸è¦çµ¦è‡ªå·±å¤ªå¤§å£“åŠ›ï¼Œ\næˆ‘æœƒä¸€ç›´é™ªè‘— {{name}}ã€‚",
                "å†è§€å¯Ÿå¹¾å¤©çœ‹çœ‹ï¼Œ\nåˆ¥å¤ªç„¦æ…®å–”ï¼",
                "ç†¬å¤œå°èº«é«”ä¸å¥½ï¼Œ\n{{name}} ä»Šå¤©è¦æ—©é»ç¡å–”ã€‚"
            ],
            special_high_bond: [
                "æˆ‘å€‘èªè­˜å¥½ä¹…äº†å‘¢ï¼Œ\nè¬è¬ {{name}} é€™éº¼ä¿¡ä»»æˆ‘ã€‚",
                "çœ‹ {{name}} é€™éº¼èªçœŸè¨˜éŒ„ï¼Œ\næˆ‘ä¹Ÿè¦æ›´åŠªåŠ›å®ˆè­·å¦³ï¼",
                "å¦‚æœå¯ä»¥ï¼ŒçœŸæƒ³\næ‘¸æ‘¸ {{name}} çš„é ­ã€‚",
                "ä»¥å¾Œçš„æ¯ä¸€å¤©ï¼Œ\néƒ½è®“æˆ‘é™ªè‘—å¦³å§ã€‚"
            ],
            shy_reaction: [
                "{{name}}...åˆ¥æˆ³æˆ‘äº†å•¦å¾ˆç™¢...",
                "å—š...åˆ¥é€™æ¨£ç›¯è‘—æˆ‘çœ‹...",
                "{{name}} çœŸæ˜¯çš„...\n(è‡‰ç´…)"
            ],
            default: [
                "{{name}} ä»Šå¤©éå¾—å¥½å—ï¼Ÿ",
                "ä¸ç®¡ç™¼ç”Ÿä»€éº¼äº‹ï¼Œ\næˆ‘éƒ½åœ¨å¦³èº«é‚Šã€‚",
                "{{name}} ç¬‘ä¸€å€‹å˜›ï¼\nå¦³ç¬‘èµ·ä¾†æœ€å¥½çœ‹äº†ã€‚"
            ]
        };

        const formatDate = (date) => {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        };

        const getMonthDays = (year, month) => {
            const date = new Date(year, month, 1);
            const days = [];
            while (date.getMonth() === month) {
                days.push(formatDate(date));
                date.setDate(date.getDate() + 1);
            }
            return days;
        };

        function WarmBuddyCalendar() {
            const [view, setView] = useState('onboarding');
            const [inputPassword, setInputPassword] = useState('');
            const [isLocked, setIsLocked] = useState(false);

            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('warmBuddy_settings');
                // é è¨­é–‹å•Ÿ dark mode
                return saved ? JSON.parse(saved) : { name: 'å°å…¬ä¸»', cycleLength: 28, periodLength: 5, enableMascot: true, notifications: true, hasOnboarded: false, password: null, darkMode: false };
            });

            const [logs, setLogs] = useState(() => {
                const saved = localStorage.getItem('warmBuddy_logs');
                return saved ? JSON.parse(saved) : {};
            });

            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(formatDate(new Date()));
            const [showLogModal, setShowLogModal] = useState(false);
            const [mascotMessage, setMascotMessage] = useState("");
            const [mascotState, setMascotState] = useState("smile");
            
            // å°‡ç‹€æ…‹æå‡è‡³çˆ¶å±¤ï¼Œç¢ºä¿åˆ‡æ›æ™‚ä¸æœƒé‡ç½®
            const [isPoke, setIsPoke] = useState(false);
            const [nurturePokeCount, setNurturePokeCount] = useState(0);
            const [isShy, setIsShy] = useState(false);

            useEffect(() => { localStorage.setItem('warmBuddy_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { localStorage.setItem('warmBuddy_logs', JSON.stringify(logs)); }, [logs]);
            
            // Dark Mode Effect
            useEffect(() => {
                if (settings.darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [settings.darkMode]);

            useEffect(() => {
                if (settings.password && !sessionStorage.getItem('unlocked')) {
                    setIsLocked(true);
                    setView('lock');
                } else if (!settings.hasOnboarded) {
                    setView('onboarding');
                } else if (view === 'onboarding') {
                    setView('calendar');
                }
            }, []);

            const bondLevel = useMemo(() => {
                const logCount = Object.keys(logs).length;
                if (logCount > 30) return 3;
                if (logCount > 10) return 2;
                if (logCount > 0) return 1;
                return 0;
            }, [logs]);

            const currentPhase = useMemo(() => {
                const today = formatDate(new Date());
                if (logs[today]?.isPeriod) return 'period';
                let lastPeriodStart = null;
                const sortedDates = Object.keys(logs).sort().reverse();
                for (let d of sortedDates) { if (logs[d].isPeriod) { lastPeriodStart = d; break; } }
                if (!lastPeriodStart) return 'default';
                const diffTime = Math.abs(new Date(today) - new Date(lastPeriodStart));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const cycleLen = parseInt(settings.cycleLength);
                const ovulationDay = cycleLen - 14;
                if (diffDays < settings.periodLength) return 'period';
                if (diffDays > cycleLen) return 'late'; 
                const ovulationDayCalc = cycleLen - 14;
                if (diffDays >= cycleLen - 3) return 'pre_period';
                if (diffDays >= ovulationDayCalc - 2 && diffDays <= ovulationDayCalc + 2) return 'ovulation';
                if (diffDays < ovulationDayCalc - 2) return 'follicular'; 
                return 'default';
            }, [logs, settings]);

            const getProcessedDialogue = (text) => {
                return text.replace(/{{name}}/g, settings.name);
            };

            useEffect(() => { updateMascotDialogue(); }, [currentPhase, settings.name]);

            const updateMascotDialogue = () => {
                // é‚è¼¯ä¿®æ­£ï¼šé²åˆ°æ™‚æ··åˆä¸€èˆ¬å°è©±ï¼Œä¸¦æ ¹æ“šé¸åˆ°çš„å°è©±æ±ºå®šè¡¨æƒ…
                let dialogues = [];
                let isMixedLate = false;

                if (currentPhase === 'late') {
                    dialogues = [...MASCOT_DIALOGUES.late, ...MASCOT_DIALOGUES.default];
                    isMixedLate = true;
                } else {
                    dialogues = MASCOT_DIALOGUES[currentPhase] || MASCOT_DIALOGUES.default;
                }

                const randomIdx = Math.floor(Math.random() * dialogues.length);
                const selectedText = dialogues[randomIdx];
                setMascotMessage(getProcessedDialogue(selectedText));
                
                // åˆ¤æ–·è¡¨æƒ…ç‹€æ…‹
                if (currentPhase === 'period' || currentPhase === 'pre_period') {
                    setMascotState('worry');
                } else if (currentPhase === 'late') {
                    if (MASCOT_DIALOGUES.late.includes(selectedText)) {
                        setMascotState('worry');
                    } else {
                        setMascotState('smile'); 
                    }
                } else if (currentPhase === 'ovulation') {
                    setMascotState('love');
                } else if (currentPhase === 'follicular') {
                    setMascotState(Math.random() > 0.5 ? 'encourage' : 'smile');
                } else {
                    setMascotState('smile');
                }
            };

            const handleCalendarPoke = () => {
                setIsPoke(true);
                setTimeout(() => setIsPoke(false), 500);
                let pokeDialogues = ["èª’ï¼Ÿæ€éº¼äº†å—ï¼Ÿ", "{{name}} åœ¨é€™å–”ã€‚", "è¦ä¹–ä¹–è¨˜éŒ„å–”ï¼", "æˆ³æˆ‘æ˜¯æƒ³æˆ‘äº†å—ï¼Ÿ"];
                if (bondLevel >= 2) {
                    pokeDialogues = [...pokeDialogues, ...MASCOT_DIALOGUES.special_high_bond];
                }
                const randomIdx = Math.floor(Math.random() * pokeDialogues.length);
                setMascotMessage(getProcessedDialogue(pokeDialogues[randomIdx]));
                setMascotState(Math.random() > 0.5 ? 'love' : 'smile');
            };

            const handleNurturePoke = () => {
                setIsPoke(true);
                setTimeout(() => setIsPoke(false), 500);
                
                const newCount = nurturePokeCount + 1;
                setNurturePokeCount(newCount);

                if (newCount >= 10) {
                    setIsShy(true);
                    setNurturePokeCount(0);
                    const shyDialogues = MASCOT_DIALOGUES.shy_reaction;
                    const randomIdx = Math.floor(Math.random() * shyDialogues.length);
                    setMascotMessage(getProcessedDialogue(shyDialogues[randomIdx]));
                    
                    setTimeout(() => {
                        setIsShy(false);
                        updateMascotDialogue(); 
                    }, 4000);
                } else {
                    let pokeDialogues = ["èª’ï¼Ÿæ€éº¼äº†å—ï¼Ÿ", "{{name}} åœ¨é€™å–”ã€‚", "è¦ä¹–ä¹–è¨˜éŒ„å–”ï¼", "æˆ³æˆ‘æ˜¯æƒ³æˆ‘äº†å—ï¼Ÿ"];
                    if (bondLevel >= 2) {
                        pokeDialogues = [...pokeDialogues, ...MASCOT_DIALOGUES.special_high_bond];
                    }
                    const randomIdx = Math.floor(Math.random() * pokeDialogues.length);
                    setMascotMessage(getProcessedDialogue(pokeDialogues[randomIdx]));
                    
                    // æˆ³æˆ³æ™‚å¦‚æœä¸æ˜¯ç‰¹æ®Šç‹€æ…‹ï¼Œéš¨æ©Ÿé¡¯ç¤º lovey_happy
                    if (!['period', 'late', 'pre_period'].includes(currentPhase)) {
                         setMascotState(Math.random() > 0.5 ? 'love' : 'smile');
                    }
                }
            };

            const togglePeriod = (dateStr) => {
                setLogs(prev => {
                    const current = prev[dateStr] || {};
                    return { ...prev, [dateStr]: { ...current, isPeriod: !current.isPeriod } };
                });
            };

            // --- Render Functions ---

            const renderLockScreen = () => (
                <div className="flex flex-col items-center justify-center h-full bg-pink-50/50 dark:bg-gray-900 p-6 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-full bg-[url('Love_Happy.png')] bg-cover opacity-10 blur-sm z-0"></div>
                    <div className="bg-white/80 dark:bg-gray-800/90 p-8 rounded-3xl shadow-xl z-10 text-center backdrop-blur-md border border-pink-100 dark:border-gray-700">
                        <div className="bg-pink-100 dark:bg-gray-700 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                            <Icon name="Lock" className="text-pink-400 dark:text-pink-300" size={32} />
                        </div>
                        <h2 className="text-xl font-bold text-gray-700 dark:text-gray-200 mb-2">æ­¡è¿å›ä¾†ï¼Œ{settings.name}</h2>
                        <input type="password" value={inputPassword} onChange={(e) => setInputPassword(e.target.value)} placeholder="è«‹è¼¸å…¥å¯†ç¢¼" className="bg-pink-50 dark:bg-gray-700 px-4 py-3 rounded-2xl border-2 border-pink-100 dark:border-gray-600 text-center text-lg mb-4 w-full focus:outline-none focus:border-pink-300 transition-colors dark:text-white" maxLength={4} />
                        <button onClick={() => { if (inputPassword === settings.password) { setIsLocked(false); sessionStorage.setItem('unlocked', 'true'); setView('calendar'); } else { alert("å¯†ç¢¼éŒ¯èª¤ > <"); } }} className="bg-gradient-to-r from-pink-400 to-pink-500 text-white w-full py-3 rounded-2xl font-bold shadow-lg shadow-pink-200 dark:shadow-none active:scale-95 transition-transform">è§£é–</button>
                    </div>
                </div>
            );

            const renderOnboarding = () => (
                <div className="flex flex-col items-center justify-center h-full p-6 relative dark:bg-gray-900">
                    <div className="absolute top-10 right-10 text-pink-200 opacity-50"><Icon name="Heart" size={40} /></div>
                    <div className="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl w-full max-w-sm border-2 border-pink-50 dark:border-gray-700 relative z-10">
                        <div className="text-center mb-8"><h1 className="text-2xl font-bold text-gray-800 dark:text-white mb-1">æš–ç”·æ—¥æ›†</h1><p className="text-pink-400 text-sm">æº«æŸ”å®ˆè­·å¦³çš„æ¯ä¸€å¤©</p></div>
                        <div className="space-y-5">
                            <div><label className="text-gray-500 dark:text-gray-400 text-xs font-bold ml-1">æ€éº¼ç¨±å‘¼å¦³å‘¢ï¼Ÿ</label><input value={settings.name} onChange={e => setSettings({...settings, name: e.target.value})} className="w-full mt-1 p-3 bg-pink-50/50 dark:bg-gray-700 dark:text-white rounded-xl border border-pink-100 dark:border-gray-600 focus:ring-2 focus:ring-pink-200 focus:outline-none" placeholder="ä¾‹å¦‚ï¼šå°ç¾" /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-gray-500 dark:text-gray-400 text-xs font-bold ml-1">å¹³å‡é€±æœŸ</label><input type="number" value={settings.cycleLength} onChange={e => setSettings({...settings, cycleLength: e.target.value})} className="w-full mt-1 p-3 bg-pink-50/50 dark:bg-gray-700 dark:text-white rounded-xl border border-pink-100 dark:border-gray-600 text-center" /></div>
                                <div><label className="text-gray-500 dark:text-gray-400 text-xs font-bold ml-1">ç¶“æœŸå¤©æ•¸</label><input type="number" value={settings.periodLength} onChange={e => setSettings({...settings, periodLength: e.target.value})} className="w-full mt-1 p-3 bg-pink-50/50 dark:bg-gray-700 dark:text-white rounded-xl border border-pink-100 dark:border-gray-600 text-center" /></div>
                            </div>
                        </div>
                        <button onClick={() => { 
                            if(settings.name && settings.cycleLength && settings.periodLength) {
                                setSettings({...settings, hasOnboarded: true}); setView('calendar'); 
                            } else {
                                alert("è«‹å…ˆå¡«å¯«è³‡æ–™å–”ï¼");
                            }
                        }} className="w-full mt-8 bg-gradient-to-r from-pink-400 to-rose-400 text-white py-4 rounded-2xl font-bold shadow-lg shadow-pink-200 dark:shadow-none hover:shadow-pink-300 transition-all active:scale-95">é–‹å§‹ä½¿ç”¨</button>
                    </div>
                </div>
            );

            const renderMascot = () => {
                if (!settings.enableMascot) return null;
                const handleImgError = (e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; };
                return (
                    <div className="fixed bottom-24 left-4 z-40 flex items-end animate-pop">
                        <div className="relative group cursor-pointer" onClick={handleCalendarPoke}>
                            <div className="w-20 h-20 md:w-24 md:h-24 rounded-full overflow-hidden border-4 border-white dark:border-gray-700 shadow-[0_4px_20px_rgba(255,182,193,0.6)] bg-pink-100 relative z-10 transition-transform transform active:scale-95">
                                <img src={Q_IMAGES[mascotState]} alt="Mascot" className="w-full h-full object-cover" onError={handleImgError} />
                                <div className="absolute inset-0 hidden items-center justify-center bg-pink-100 text-4xl">{mascotState === 'smile' ? 'ğŸ‘¦ğŸ»' : mascotState === 'worry' ? 'ğŸ˜Ÿ' : mascotState === 'love' ? 'ğŸ¥°' : 'ğŸ˜‰'}</div>
                            </div>
                            <div className="absolute left-16 bottom-16 bg-white dark:bg-gray-800 px-4 py-3 rounded-2xl rounded-bl-none shadow-lg border-2 border-pink-100 dark:border-gray-700 w-48 z-20 animate-float origin-bottom-left">
                                <p className="text-gray-600 dark:text-gray-200 text-sm font-medium leading-relaxed whitespace-pre-line">{mascotMessage}</p>
                                <Icon name="Heart" size={12} className="text-pink-400 absolute -top-2 -right-2 fill-current animate-bounce" />
                            </div>
                        </div>
                    </div>
                );
            };

            const renderCalendarView = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = getMonthDays(year, month);
                const firstDayObj = new Date(year, month, 1);
                const startPadding = firstDayObj.getDay(); 

                const getDayStatus = (dateStr) => {
                    if (logs[dateStr]?.isPeriod) return 'period-active';
                    let lastPeriodStart = null;
                    const sortedDates = Object.keys(logs).sort().reverse();
                    const lastPeriodDate = sortedDates.find(d => logs[d].isPeriod);
                    if (lastPeriodDate) {
                        const lastDate = new Date(lastPeriodDate);
                        const cycleLen = parseInt(settings.cycleLength);
                        const diffDays = Math.floor((new Date(dateStr) - lastDate) / (1000 * 60 * 60 * 24));
                        if (new Date(dateStr) < new Date() && !logs[dateStr]?.isPeriod) return 'none';
                        const cycleDay = diffDays % cycleLen;
                        if (cycleDay >= 0 && cycleDay < settings.periodLength) {
                            if (new Date(dateStr) < new Date()) return 'none';
                            return 'period-predicted';
                        }
                        if (cycleDay === cycleLen - 14) return 'ovulation';
                    }
                    return 'none';
                };

                return (
                    <div className="flex flex-col h-full relative">
                        <div className="flex items-center justify-between px-6 pt-10 pb-4 bg-white/50 dark:bg-gray-900/50 backdrop-blur-sm z-10">
                            <button onClick={() => setCurrentDate(new Date(year, month - 1))} className="p-2 bg-white dark:bg-gray-800 rounded-full text-pink-400 shadow-sm active:scale-95"><Icon name="ChevronLeft" /></button>
                            <h2 className="text-2xl font-bold text-gray-700 dark:text-gray-100 tracking-widest">{year}.{String(month + 1).padStart(2, '0')}</h2>
                            <button onClick={() => setCurrentDate(new Date(year, month + 1))} className="p-2 bg-white dark:bg-gray-800 rounded-full text-pink-400 shadow-sm active:scale-95"><Icon name="ChevronRight" /></button>
                        </div>

                        <div className="grid grid-cols-7 text-center py-2 text-pink-300 font-bold text-xs bg-white/30 dark:bg-gray-800/30">
                            <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                        </div>

                        <div className="grid grid-cols-7 gap-3 p-4 overflow-y-auto no-scrollbar pb-64">
                            {Array(startPadding).fill(null).map((_, i) => <div key={`pad-${i}`} />)}
                            
                            {daysInMonth.map(dateStr => {
                                const status = getDayStatus(dateStr);
                                const isSelected = dateStr === selectedDate;
                                const isToday = dateStr === formatDate(new Date());
                                const logExists = logs[dateStr];
                                let bgClass = "bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 shadow-sm border border-transparent";
                                if (status === 'period-active') bgClass = "bg-rose-400 text-white shadow-rose-200 shadow-md border-rose-400";
                                else if (status === 'period-predicted') bgClass = "bg-pink-50 dark:bg-gray-700 text-pink-400 border-dashed border-pink-200 dark:border-gray-600 border-2";
                                else if (status === 'ovulation') bgClass = "bg-purple-50 dark:bg-gray-700 text-purple-500 border-purple-200 dark:border-purple-900 border";
                                if (isSelected) bgClass += " ring-2 ring-pink-400 ring-offset-2 ring-offset-pink-50 dark:ring-offset-gray-900 scale-105 z-10";
                                return (
                                    <div key={dateStr} onClick={() => setSelectedDate(dateStr)} className={`aspect-square rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all relative ${bgClass}`}>
                                        <span className={`text-sm font-bold ${isToday ? 'underline decoration-2 underline-offset-2' : ''}`}>{parseInt(dateStr.split('-')[2])}</span>
                                        <div className="flex gap-1 mt-1 h-1.5">{logExists?.symptoms?.length > 0 && <div className="w-1.5 h-1.5 rounded-full bg-yellow-400"></div>}{logExists?.temp && <div className="w-1.5 h-1.5 rounded-full bg-blue-300"></div>}</div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div className="absolute bottom-24 right-4 z-30 animate-pop flex flex-col gap-2 w-28">
                            <div className="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm p-3 rounded-2xl shadow-lg border border-white/50 dark:border-gray-700 text-center">
                                <div className="text-[10px] text-gray-400 font-bold mb-0.5">SELECTED</div>
                                <div className="text-2xl font-black text-gray-700 dark:text-white font-mono leading-none">{selectedDate.split('-')[2]}</div>
                                <div className="text-xs font-bold text-gray-400">{selectedDate.split('-')[1]}æœˆ</div>
                            </div>

                            <div className="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm p-2 rounded-2xl shadow-lg border border-white/50 dark:border-gray-700 flex flex-col gap-2">
                                <button onClick={() => togglePeriod(selectedDate)} className={`w-full aspect-square rounded-xl flex flex-col items-center justify-center gap-1 transition-all active:scale-90 ${logs[selectedDate]?.isPeriod ? 'bg-rose-400 text-white shadow-md' : 'bg-pink-50 dark:bg-gray-700 text-pink-400'}`}>
                                    <Icon name="Droplet" size={24} className={logs[selectedDate]?.isPeriod ? 'fill-white' : 'fill-pink-400'} />
                                    <span className="text-xs font-bold">{logs[selectedDate]?.isPeriod ? 'çµæŸ' : 'ä¾†äº†'}</span>
                                </button>
                                <button onClick={() => setShowLogModal(true)} className="w-full py-2 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-300 text-xs font-bold active:scale-95 hover:bg-gray-100 dark:hover:bg-gray-600">
                                    è©³ç´°
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderLogModal = () => {
                if (!showLogModal) return null;
                const currentLog = logs[selectedDate] || { symptoms: [], flow: '', temp: '' };
                const symptomsList = ['ğŸ˜­ ç¶“ç—›', 'ğŸ˜« é ­ç—›', 'ğŸ˜®â€ğŸ’¨ è…°ç— ', 'ğŸ˜¡ æ˜“æ€’', 'ğŸ˜£ ç–²æ†Š', 'ğŸ« è²ªåƒ', 'ğŸ˜ æ†‚é¬±', 'ğŸˆ èƒ¸æ¼²'];
                const save = (key, val) => { setLogs(prev => ({ ...prev, [selectedDate]: { ...prev[selectedDate], [key]: val } })); };
                const toggleSym = (s) => { const list = currentLog.symptoms || []; save('symptoms', list.includes(s) ? list.filter(i => i !== s) : [...list, s]); };
                return (
                    <div className="fixed inset-0 bg-black/30 backdrop-blur-[2px] z-50 flex items-end justify-center" onClick={(e) => e.target === e.currentTarget && setShowLogModal(false)}>
                        <div className="bg-white dark:bg-gray-800 w-full max-w-md rounded-t-[2rem] p-6 pb-12 animate-float shadow-2xl">
                            <div className="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mx-auto mb-6"></div>
                            <h3 className="text-lg font-bold text-gray-700 dark:text-white mb-6 flex items-center gap-2"><div className="w-2 h-6 bg-pink-400 rounded-full"></div>è©³ç´°è¨˜éŒ„</h3>
                            <div className="space-y-6">
                                <div><label className="text-sm font-bold text-gray-400 mb-2 block">ç¶“è¡€é‡</label><div className="flex gap-3">{['å°‘', 'ä¸­', 'å¤š'].map(l => (<button key={l} onClick={() => save('flow', l)} className={`flex-1 py-3 rounded-2xl text-sm font-bold transition-all ${currentLog.flow === l ? 'bg-rose-400 text-white shadow-md scale-105' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300'}`}>{l}</button>))}</div></div>
                                <div><label className="text-sm font-bold text-gray-400 mb-2 block">ç—‡ç‹€</label><div className="grid grid-cols-4 gap-2">{symptomsList.map(s => (<button key={s} onClick={() => toggleSym(s)} className={`py-2 rounded-xl text-xs font-bold transition-all ${currentLog.symptoms?.includes(s) ? 'bg-pink-100 text-pink-600 border border-pink-200' : 'bg-white dark:bg-gray-700 border border-gray-100 dark:border-gray-600 text-gray-500 dark:text-gray-300'}`}>{s.split(' ')[1]}</button>))}</div></div>
                                <div><label className="text-sm font-bold text-gray-400 mb-2 block">é«”æº«</label><input type="number" value={currentLog.temp || ''} onChange={e => save('temp', e.target.value)} className="w-full bg-gray-50 dark:bg-gray-700 p-3 rounded-xl border-none font-bold text-gray-700 dark:text-white focus:ring-2 focus:ring-pink-200" placeholder="Â°C" /></div>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderSettingsView = () => (
                <div className="h-full overflow-y-auto p-6 pt-10 pb-24">
                    <h2 className="text-2xl font-bold text-gray-700 dark:text-white mb-6">è¨­å®š</h2>
                    <div className="space-y-4">
                        <div className="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-sm border border-pink-50 dark:border-gray-700">
                            <div className="text-sm text-pink-400 font-bold mb-4">åŸºæœ¬è³‡æ–™</div>
                            <div className="space-y-3">
                                <input value={settings.name} onChange={e => setSettings({...settings, name: e.target.value})} className="w-full p-3 bg-pink-50/50 dark:bg-gray-700 dark:text-white rounded-xl text-gray-600 font-bold border-none" />
                                <div className="flex gap-3">
                                    <div className="flex-1 bg-pink-50/50 dark:bg-gray-700 rounded-xl p-3"><div className="text-xs text-gray-400">é€±æœŸ</div><input type="number" value={settings.cycleLength} onChange={e => setSettings({...settings, cycleLength: e.target.value})} className="bg-transparent w-full font-bold text-gray-700 dark:text-white" /></div>
                                    <div className="flex-1 bg-pink-50/50 dark:bg-gray-700 rounded-xl p-3"><div className="text-xs text-gray-400">ç¶“æœŸ</div><input type="number" value={settings.periodLength} onChange={e => setSettings({...settings, periodLength: e.target.value})} className="bg-transparent w-full font-bold text-gray-700 dark:text-white" /></div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-sm border border-pink-50 dark:border-gray-700">
                            <div className="text-sm text-pink-400 font-bold mb-4">åŠŸèƒ½è¨­å®š</div>
                            
                            {/* æ·±è‰²æ¨¡å¼é–‹é—œ */}
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-gray-600 dark:text-gray-300 font-bold flex items-center gap-2"><Icon name="Moon" size={18} /> å¤œé–“æ¨¡å¼</span>
                                <button onClick={() => setSettings({...settings, darkMode: !settings.darkMode})} className={`w-12 h-7 rounded-full relative transition-colors ${settings.darkMode ? 'bg-indigo-500' : 'bg-gray-200 dark:bg-gray-600'}`}>
                                    <div className={`w-5 h-5 bg-white rounded-full absolute top-1 transition-all ${settings.darkMode ? 'left-6' : 'left-1'}`}></div>
                                </button>
                            </div>

                            <div className="flex justify-between items-center mb-4 border-t border-gray-100 dark:border-gray-700 pt-4"><span className="text-gray-600 dark:text-gray-300 font-bold flex items-center gap-2"><Icon name="Smile" size={18} /> æš–ç”·é™ªä¼´</span><button onClick={() => setSettings({...settings, enableMascot: !settings.enableMascot})} className={`w-12 h-7 rounded-full relative transition-colors ${settings.enableMascot ? 'bg-pink-400' : 'bg-gray-200 dark:bg-gray-600'}`}><div className={`w-5 h-5 bg-white rounded-full absolute top-1 transition-all ${settings.enableMascot ? 'left-6' : 'left-1'}`}></div></button></div>
                            <div className="flex flex-col gap-2 border-t border-gray-100 dark:border-gray-700 pt-4"><span className="text-gray-600 dark:text-gray-300 font-bold flex items-center gap-2"><Icon name="Lock" size={18} /> éš±ç§é–</span><input type="text" maxLength={4} placeholder="è¼¸å…¥ 4 ä½æ•¸å¯†ç¢¼" value={settings.password || ''} onChange={e => setSettings({...settings, password: e.target.value})} className="bg-gray-50 dark:bg-gray-700 dark:text-white w-full p-3 rounded-xl text-center tracking-widest font-bold" /></div>
                        </div>
                        <button onClick={() => { localStorage.clear(); location.reload(); }} className="w-full py-4 text-rose-300 font-bold text-sm bg-white dark:bg-gray-800 rounded-3xl border border-rose-100 dark:border-gray-700">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                    </div>
                </div>
            );

            const renderStatsView = () => {
                const logDates = Object.keys(logs).sort();
                const totalLogs = logDates.length;
                let periodCount = 0;
                let cycleDaysSum = 0;
                let cycleCount = 0;
                let lastPeriodDate = null;

                const startDates = [];
                for (let i = 0; i < logDates.length; i++) {
                    const d = logDates[i];
                    if (logs[d].isPeriod) {
                        periodCount++;
                        const prevDay = new Date(d);
                        prevDay.setDate(prevDay.getDate() - 1);
                        const prevDayStr = formatDate(prevDay);
                        if (!logs[prevDayStr] || !logs[prevDayStr].isPeriod) {
                            startDates.push(d);
                        }
                    }
                }

                if (startDates.length > 1) {
                    for (let i = 0; i < startDates.length - 1; i++) {
                        const diff = (new Date(startDates[i+1]) - new Date(startDates[i])) / (1000 * 60 * 60 * 24);
                        if (diff < 40 && diff > 20) { 
                            cycleDaysSum += diff;
                            cycleCount++;
                        }
                    }
                }

                const avgCycle = cycleCount > 0 ? Math.round(cycleDaysSum / cycleCount) : settings.cycleLength;
                const lastPeriod = startDates.length > 0 ? startDates[startDates.length - 1] : "å°šæœªè¨˜éŒ„";
                const nextPeriodPred = lastPeriod !== "å°šæœªè¨˜éŒ„" ? formatDate(new Date(new Date(lastPeriod).getTime() + avgCycle * 24 * 60 * 60 * 1000)) : "éœ€æ›´å¤šè³‡æ–™";

                return (
                    <div className="h-full overflow-y-auto p-6 pt-10 pb-24 space-y-6">
                        <h2 className="text-2xl font-bold text-gray-700 dark:text-white">é€±æœŸçµ±è¨ˆ</h2>
                        <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-pink-50 dark:border-gray-700 flex items-center justify-between">
                            <div>
                                <div className="text-sm text-gray-400 font-bold mb-1">é æ¸¬ä¸‹æ¬¡ç¶“æœŸ</div>
                                <div className="text-3xl text-pink-500 font-bold">{nextPeriodPred.split('-').slice(1).join('/')}</div>
                            </div>
                            <div className="bg-pink-100 dark:bg-gray-700 p-3 rounded-full text-pink-400"><Icon name="Calendar" /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-sm border border-pink-50 dark:border-gray-700 text-center">
                                <div className="text-xs text-gray-400 font-bold mb-2">å¹³å‡é€±æœŸ</div>
                                <div className="text-2xl text-gray-700 dark:text-white font-bold">{avgCycle} <span className="text-sm text-gray-400">å¤©</span></div>
                            </div>
                             <div className="bg-white dark:bg-gray-800 p-5 rounded-3xl shadow-sm border border-pink-50 dark:border-gray-700 text-center">
                                <div className="text-xs text-gray-400 font-bold mb-2">æœ€è¿‘ä¸€æ¬¡</div>
                                <div className="text-lg text-gray-700 dark:text-white font-bold">{lastPeriod !== "å°šæœªè¨˜éŒ„" ? lastPeriod.split('-').slice(1).join('/') : "--/--"}</div>
                            </div>
                        </div>
                         <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-sm border border-pink-50 dark:border-gray-700">
                            <div className="text-sm text-gray-400 font-bold mb-4">è¨˜éŒ„æ¦‚æ³</div>
                            <div className="space-y-3">
                                <div className="flex justify-between text-sm">
                                    <span className="text-gray-600 dark:text-gray-300">ç¸½è¨˜éŒ„å¤©æ•¸</span>
                                    <span className="font-bold text-pink-400">{periodCount} å¤©</span>
                                </div>
                                <div className="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-2">
                                    <div className="bg-pink-300 h-2 rounded-full" style={{width: `${Math.min(periodCount, 100)}%`}}></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const renderNurtureView = () => {
                const bondText = bondLevel === 0 ? "åˆè­˜" : bondLevel === 1 ? "æœ‹å‹" : bondLevel === 2 ? "æ›–æ˜§" : "æˆ€äºº";
                const bondColor = bondLevel === 0 ? "text-gray-400" : bondLevel === 1 ? "text-blue-400" : bondLevel === 2 ? "text-pink-400" : "text-rose-500";
                const handleImgError = (e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; };
                
                // åœ–ç‰‡å°æ‡‰é‚è¼¯ä¿®æ­£ (æ–°å¢ lovey_happy)
                const getNurtureImage = () => {
                    if (isShy) return NORMAL_IMAGES.shy;
                    if (currentPhase === 'period') return NORMAL_IMAGES.cocoa;
                    if (mascotState === 'worry') return NORMAL_IMAGES.worry;
                    // æ–°å¢ï¼šå¦‚æœç‹€æ…‹æ˜¯ love (é€éæˆ³æˆ³æˆ–æ’åµæœŸ)ï¼Œé¡¯ç¤º lovey_happy
                    if (mascotState === 'love') return NORMAL_IMAGES.lovey_happy;
                    
                    return NORMAL_IMAGES.normal;
                };

                return (
                    <div className="h-full flex flex-col items-center justify-between pt-10 pb-24 relative overflow-hidden bg-gradient-to-b from-pink-50/50 to-white dark:from-gray-900 dark:to-gray-800">
                        <div className="absolute top-20 left-10 text-pink-100 dark:text-gray-700 animate-float"><Icon name="Heart" size={60} /></div>
                        <div className="absolute top-40 right-10 text-pink-100 dark:text-gray-700 animate-float" style={{animationDelay: '1s'}}><Icon name="Heart" size={40} /></div>
                        <div className="w-full px-8 z-10">
                            <div className="flex justify-between items-end mb-2">
                                <h2 className="text-2xl font-bold text-gray-700 dark:text-white">æš–ç”·ç›¸è™•</h2>
                                <div className={`font-bold ${bondColor} flex items-center gap-1`}><Icon name="Heart" size={16} className="fill-current" /> {bondText}</div>
                            </div>
                            <div className="w-full bg-white dark:bg-gray-700 h-3 rounded-full shadow-inner border border-pink-100 dark:border-gray-600">
                                <div className="bg-gradient-to-r from-pink-300 to-rose-400 h-3 rounded-full transition-all duration-1000" style={{width: `${Math.min(Object.keys(logs).length * 2, 100)}%`}}></div>
                            </div>
                            <p className="text-xs text-gray-400 mt-2 text-right">æŒçºŒè¨˜éŒ„ç¶“æœŸä¾†æå‡å¥½æ„Ÿåº¦å§ï¼</p>
                        </div>
                        <div className="flex-1 w-full flex items-end justify-center relative z-10 -mb-10 cursor-pointer" onClick={handleNurturePoke}>
                            <div className={`transition-transform duration-200 ${isPoke ? 'scale-95' : 'hover:scale-105'} relative`}>
                                {/* ä¿®æ­£ï¼šå°è©±æ¡†ä½ç½®åå·¦ (-translate-x-2/3) */}
                                <div className="absolute -top-40 left-1/3 -translate-x-1/2 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm px-6 py-4 rounded-3xl shadow-lg border-2 border-pink-100 dark:border-gray-600 w-64 text-center animate-float z-20">
                                    <p className="text-gray-600 dark:text-gray-200 font-bold whitespace-pre-line">{mascotMessage}</p>
                                    <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 rotate-45 w-4 h-4 bg-white dark:bg-gray-800 border-b-2 border-r-2 border-pink-100 dark:border-gray-600"></div>
                                </div>
                                <div className={`w-64 md:w-80 transition-all ${isPoke ? 'animate-wiggle' : ''} ${isShy ? 'animate-shake' : ''}`}>
                                    <img src={getNurtureImage()} className="w-full h-auto drop-shadow-2xl mask-image-gradient-b" alt="Character" onError={handleImgError} />
                                     <div className="hidden h-64 w-64 items-center justify-center text-9xl">{isShy ? 'ğŸ¥°' : 'ğŸ‘¦ğŸ»'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            if (view === 'lock') return renderLockScreen();
            if (view === 'onboarding') return renderOnboarding();

            return (
                <div className="h-full w-full flex flex-col relative font-sans">
                    <div className="flex-1 overflow-hidden relative z-0">
                        {view === 'calendar' && renderCalendarView()}
                        {view === 'settings' && renderSettingsView()}
                        {view === 'stats' && renderStatsView()}
                        {view === 'nurture' && renderNurtureView()}
                    </div>
                    {view === 'calendar' && renderMascot()}
                    {renderLogModal()}
                    <div className="h-20 bg-white dark:bg-gray-900 border-t border-pink-100 dark:border-gray-800 flex items-center justify-around px-2 pb-6 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
                        {[{ id: 'calendar', icon: 'Calendar', label: 'æ—¥æ›†' }, { id: 'stats', icon: 'BarChart2', label: 'çµ±è¨ˆ' }, { id: 'nurture', icon: 'Heart', label: 'ç›¸è™•' }, { id: 'settings', icon: 'Settings', label: 'è¨­å®š' }].map(item => (<button key={item.id} onClick={() => setView(item.id)} className="w-16 flex flex-col items-center gap-1 group"><div className={`p-2 rounded-2xl transition-all ${view === item.id ? 'bg-pink-100 text-pink-500 dark:bg-gray-800 dark:text-pink-300 -translate-y-2 shadow-sm' : 'text-gray-300 group-hover:text-gray-400'}`}><Icon name={item.icon} size={24} className={view === item.id ? 'fill-pink-200 dark:fill-pink-900' : ''} /></div><span className={`text-[10px] font-bold ${view === item.id ? 'text-pink-500 dark:text-pink-300' : 'text-gray-300'}`}>{item.label}</span></button>))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WarmBuddyCalendar />);
    </script>
</body>
</html>